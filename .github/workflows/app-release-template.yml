name: Release (Blacksmith Windows) - Nest Server Deploy Bundle

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

env:
  NODE_VERSION: "22"
  ARTIFACT_BASENAME: "server-win-x64"
  INCLUDE_NODE_MODULES: "false"

jobs:
  build_and_release:
    runs-on: blacksmith-4vcpu-windows-2025

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Enable Corepack (pnpm)
        shell: pwsh
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm --version
          node --version

      - name: Install dependencies
        shell: pwsh
        run: |
          pnpm install --frozen-lockfile

      - name: Build
        shell: pwsh
        run: |
          pnpm build

      - name: Prepare deploy bundle folder
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          $baseVersion = $pkg.version
          if (-not $baseVersion) { throw "package.json missing version" }

          $releaseVersion = "$baseVersion+${{ github.run_number }}"
          echo "RELEASE_VERSION=$releaseVersion" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          $bundleDir = Join-Path $PWD "bundle"
          if (Test-Path $bundleDir) { Remove-Item $bundleDir -Recurse -Force }
          New-Item -ItemType Directory -Path $bundleDir | Out-Null

          Copy-Item -Recurse -Force "dist" $bundleDir
          Copy-Item -Force "package.json" $bundleDir
          Copy-Item -Force "pnpm-lock.yaml" $bundleDir

          Set-Content -Path (Join-Path $bundleDir "version.txt") -Value $releaseVersion -Encoding utf8

      - name: Optionally bundle production node_modules
        if: ${{ env.INCLUDE_NODE_MODULES == 'true' }}
        shell: pwsh
        run: |
          pnpm prune --prod
          Copy-Item -Recurse -Force "node_modules" "bundle"

      - name: Create zip + SHA256
        shell: pwsh
        run: |
          $zipName = "${{ env.ARTIFACT_BASENAME }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }

          Compress-Archive -Path "bundle\*" -DestinationPath $zipName -Force

          $hash = (Get-FileHash -Algorithm SHA256 $zipName).Hash.ToLower()
          Set-Content -Path "build.sha256" -Value "$hash  $zipName" -Encoding utf8

          echo "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.RELEASE_VERSION }}"
          name: "v${{ env.RELEASE_VERSION }}"
          generate_release_notes: true
          files: |
            ${{ env.ZIP_NAME }}
            build.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
